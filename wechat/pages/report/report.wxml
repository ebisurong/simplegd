<!--pages/report/report.wxml-->
<view class="page-container">
  <!-- æ—¥æœŸå’Œé»„å†ä¿¡æ¯ -->
  <view class="date-calendar-header">
    <view class="date-info">
      <view class="date-text">{{currentDate}}</view>
    </view>
    <view class="calendar-info">
      <view class="calendar-text">{{calendarInfo}}</view>
    </view>
  </view>

  <!-- å·¥ç§ä¸å®‰è£…å†…å®¹é€‰æ‹© -->
  <view class="card mb-20">
    <view class="card-header">
      <view class="card-title">å®‰è£…å·¥ç§ä¸å†…å®¹</view>
    </view>
    <view class="card-content">
      <!-- å·¥ç§é€‰æ‹©åŒºåŸŸ (2è¡Œ4åˆ—) -->
      <view class="work-type-selection">
        <view class="work-type-title">é€‰æ‹©å·¥ç§</view>
        <view class="work-type-grid">
          <view wx:for="{{workTypeList}}" wx:for-item="workType" wx:for-index="index" wx:key="key" 
                class="{{selectedWorkTypeKey === workType.key ? 'work-type-item selected' : 'work-type-item'}}" 
                bindtap="onWorkTypeSelect" 
                data-key="{{workType.key}}">
            {{workType.label}}
          </view>
        </view>
      </view>
      
      <!-- å®‰è£…å†…å®¹é€‰æ‹©åŒºåŸŸ -->
      <view class="content-selection-area">
        <view class="section-title">å®‰è£…å†…å®¹ - {{currentWorkType.label}}</view>
        <view class="content-grid">
          <view 
            wx:for="{{currentWorkType.contents}}" 
            wx:key="value"
            class="content-item {{item.checked ? 'selected' : ''}}"
            data-content="{{item.value}}"
            bindtap="onContentSelect"
          >
            {{item.label}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- é€‰æ‹©æ±‡æ€»æ˜¾ç¤º -->
  <view class="card mb-20">
    <view class="card-header">
      <view class="card-title">å·²é€‰æ‹©å†…å®¹</view>
    </view>
    <view class="card-content">
      <view class="summary-section">
        <view class="summary-header">
          <text class="summary-title">å½“å‰é€‰æ‹©</text>
          <text class="summary-total">å…±{{selectedWorkTypeCount}}ä¸ªå·¥ç§ï¼Œå…±{{selectedContentCount}}ä¸ªå†…å®¹</text>
        </view>
        
        <view wx:if="{{Object.keys(selectedSummary).length === 0}}" class="summary-empty">
          æš‚æœªé€‰æ‹©ä»»ä½•å®‰è£…å†…å®¹
        </view>
        
        <view wx:else>
          <view wx:for="{{selectedSummary}}" wx:for-item="summaryItem" wx:for-index="workTypeKey" wx:key="workTypeKey" class="summary-group">
            <view class="summary-group-title">{{summaryItem.label}}</view>
            <view class="summary-items">
              <view wx:for="{{summaryItem.contents}}" wx:for-item="content" wx:key="value" class="summary-item">
                {{content.label}}
                <view class="summary-item-remove" 
                      bindtap="onSummaryContentRemove" 
                      data-worktype="{{workTypeKey}}" 
                      data-contentvalue="{{content.value}}">
                  <image src="/images/cancle.png" class="remove-icon" mode="aspectFit"></image>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç°åœºç…§ç‰‡ -->
  <view class="card mb-20">
    <view class="card-header">
      <view class="card-title">ç°åœºç…§ç‰‡</view>
      <view class="photo-count">{{photos.length}}/9</view>
    </view>
    <view class="card-content">
      <view class="photo-grid">
        <!-- å·²é€‰æ‹©çš„ç…§ç‰‡ -->
        <view class="photo-item" wx:for="{{photos}}" wx:key="index">
          <image src="{{item.path}}" mode="aspectFill" class="photo-image" bindtap="previewPhoto" data-index="{{index}}"></image>
          <view class="photo-delete" bindtap="deletePhoto" data-index="{{index}}">Ã—</view>
          <view class="photo-watermark" wx:if="{{item.hasWatermark}}">å·²æ·»åŠ æ°´å°</view>
        </view>
        
        <!-- æ·»åŠ ç…§ç‰‡æŒ‰é’® -->
        <view class="photo-add" wx:if="{{photos.length < 9}}" bindtap="choosePhoto">
          <text class="add-icon">ğŸ“·</text>
          <text class="add-text">æ‹ç…§</text>
        </view>
      </view>
      
      <view class="photo-tips">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">å»ºè®®æ‹æ‘„æ¸…æ™°çš„ç°åœºç…§ç‰‡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ·»åŠ é¡¹ç›®ä¿¡æ¯æ°´å°</text>
      </view>
    </view>
  </view>

  <!-- è¯­éŸ³è¾“å…¥æ–‡æœ¬æ¡† -->
  <view class="card mb-20">
    <view class="card-header">
      <view class="card-title">å¤‡æ³¨è¯´æ˜</view>
    </view>
    <view class="card-content">
      <view class="voice-input-container">
        <textarea class="voice-textarea" 
                  value="{{voiceText}}" 
                  bindinput="onVoiceTextInput" 
                  placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯æˆ–ç‚¹å‡»è¯­éŸ³è¾“å…¥" 
                  maxlength="500"
                  auto-height></textarea>
        <view class="voice-controls">
          <view class="voice-btn {{isRecording ? 'recording' : ''}}" 
                bindtouchstart="startRecord" 
                bindtouchend="stopRecord">
            <image src="{{isRecording ? '/images/stop.png' : '/images/voice.png'}}" class="voice-icon-img" mode="aspectFit"></image>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ä½ç½®ä¿¡æ¯ -->
  <view class="card mb-20">
    <view class="card-header">
      <view class="card-title">ä½ç½®ä¿¡æ¯</view>
    </view>
    <view class="card-content">
      <view class="location-info">
        <view class="location-item">
          <text class="location-label">é¡¹ç›®åç§°ï¼š</text>
          <text class="location-value">{{projectName || 'æœªè®¾ç½®'}}</text>
        </view>
        <view class="location-item" wx:if="{{locationName}}">
          <text class="location-label">è¯¦ç»†åœ°å€ï¼š</text>
          <text class="location-value">{{locationName}}</text>
        </view>
        <view class="location-item" wx:if="{{currentLocation}}">
          <text class="location-label">GPSåæ ‡ï¼š</text>
          <text class="location-value">{{currentLocation.latitude}}, {{currentLocation.longitude}}</text>
        </view>
      </view>
      
      <button class="btn btn-secondary location-btn" bindtap="getCurrentLocation">
        <text class="btn-icon">ğŸ“</text>
        {{currentLocation ? 'é‡æ–°å®šä½' : 'è·å–ä½ç½®'}}
      </button>
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="submit-section">
    <button class="btn btn-primary submit-btn" bindtap="submitOrder" disabled="{{submitting}}">
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤å·¥å•'}}
    </button>
  </view>
</view>



<!-- åŠ è½½æç¤º -->
<view class="loading-overlay" wx:if="{{processing}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <view class="loading-text">{{loadingText}}</view>
  </view>
</view>

<!-- éšè—çš„canvasç”¨äºæ°´å°å¤„ç† -->
<canvas canvas-id="watermarkCanvas" style="position: fixed; top: -1000px; left: -1000px; width: 400px; height: 300px;"></canvas>