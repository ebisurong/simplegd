<!--pages/history/history.wxml-->
<view class="page-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <!-- <view class="page-header">
    <view class="page-title">å†å²å·¥å•</view>
    <view class="page-desc">æŸ¥çœ‹å’Œç®¡ç†å·²æäº¤çš„å·¥å•</view>
  </view> -->

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-section">
    <view class="search-box">
      <input class="search-input" value="{{searchKeyword}}" bindinput="onSearchInput" placeholder="æœç´¢å·¥å•ç¼–å·ã€é¡¹ç›®åç§°" confirm-type="search" bindconfirm="doSearch" />
      <view class="search-btn" bindtap="doSearch">
        <text class="search-icon">ğŸ”</text>
      </view>
    </view>
    
    <view class="filter-row">
      <picker bindchange="onStatusFilterChange" value="{{statusFilterIndex}}" range="{{statusFilterList}}" class="filter-picker">
        <view class="filter-item">
          <text class="filter-label">{{statusFilterList[statusFilterIndex]}}</text>
          <text class="filter-arrow">â–¼</text>
        </view>
      </picker>
      
      <picker bindchange="onTimeFilterChange" value="{{timeFilterIndex}}" range="{{timeFilterList}}" class="filter-picker">
        <view class="filter-item">
          <text class="filter-label">{{timeFilterList[timeFilterIndex]}}</text>
          <text class="filter-arrow">â–¼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section" wx:if="{{showStats}}">
    <view class="stat-card">
      <text class="stat-number">{{totalOrders}}</text>
      <text class="stat-label">æ€»å·¥å•</text>
    </view>
    <view class="stat-card">
      <text class="stat-number">{{pendingCount}}</text>
      <text class="stat-label">å¾…å¤„ç†</text>
    </view>
    <view class="stat-card">
      <text class="stat-number">{{completedCount}}</text>
      <text class="stat-label">å·²å®Œæˆ</text>
    </view>
  </view>

  <!-- å·¥å•åˆ—è¡¨ -->
  <view class="order-list">
    <view class="order-card" wx:for="{{filteredOrders}}" wx:for-index="orderIndex" wx:key="id">
      <!-- å·¥å•å¤´éƒ¨ -->
      <view class="order-header">
        <view class="order-number">å·¥å•ç¼–å·#{{item.id}}</view>
        <view class="order-time">{{item.createTime}}</view>
      </view>

      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="order-info">
        <view class="info-item">
          <text class="info-label">é¡¹ç›®åç§°ï¼š</text>
          <text class="info-value">{{item.projectName || item.title}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">æäº¤äººï¼š</text>
          <text class="info-value">{{item.submitter || 'æœªçŸ¥'}}</text>
        </view>
      </view>

      <!-- å·¥ä½œå†…å®¹ -->
      <view class="work-content">
        <view class="work-section" wx:if="{{item.workTypes && item.workTypes.length > 0}}">
          <text class="work-title">å·¥ç§ç±»å‹ï¼š</text>
          <view class="work-tags">
            <text class="work-tag work-type" wx:for="{{item.workTypes}}" wx:key="*this">{{item}}</text>
          </view>
        </view>
        
        <view class="work-section" wx:if="{{item.installContents && item.installContents.length > 0}}">
          <text class="work-title">å®‰è£…å†…å®¹ï¼š</text>
          <view class="work-tags">
            <text class="work-tag install-content" wx:for="{{item.installContents}}" wx:key="*this">{{item}}</text>
          </view>
        </view>
      </view>

      <!-- å¤‡æ³¨è¯´æ˜ -->
      <view class="remark-section" wx:if="{{item.description || item.voiceText}}">
        <text class="section-title">å¤‡æ³¨è¯´æ˜</text>
        <view class="remark-content">
          <text class="remark-text">{{item.voiceText}}</text>
        </view>
      </view>

      <!-- ç°åœºç…§ç‰‡ -->
      <view class="photos-section" wx:if="{{item.photos && item.photos.length > 0}}">
        <view class="photos-header">
          <text class="section-title">ç°åœºç…§ç‰‡</text>
          <text class="photos-count">({{item.photos.length}}å¼ )</text>
        </view>
        <view class="photos-grid">
          <view class="photo-item" wx:for="{{item.photos}}" wx:for-item="photo" wx:for-index="photoIndex" wx:key="photoIndex" wx:if="{{photoIndex < 6}}" bindtap="previewPhotos" data-photos="{{item.photos}}" data-index="{{photoIndex}}">
            <image src="{{photo.path || photo.url}}" mode="aspectFill" class="photo-image" lazy-load="true"></image>
          
          </view>
          <view class="photo-more" wx:if="{{item.photos.length > 6}}" bindtap="viewPhotos" data-photos="{{item.photos}}">
            <text class="more-text">æŸ¥çœ‹å…¨éƒ¨</text>
            <text class="more-count">+{{item.photos.length - 6}}</text>
          </view>
        </view>
      </view>

      <!-- æ–½å·¥é˜¶æ®µ -->
      <view class="construction-section">
        <view class="construction-header">
          <text class="section-title">æ–½å·¥é˜¶æ®µ</text>
          <text class="selected-count">å·²é€‰{{item.selectedStagesCount || 0}}é¡¹</text>
        </view>
        <view class="construction-grid">
          <view class="stage-item {{stage.checked ? 'selected' : ''}}" wx:for="{{item.constructionStages}}" wx:for-item="stage" wx:for-index="stageIndex" wx:key="value" bindtap="stageCheckbox" data-order-index="{{orderIndex}}" data-stage-index="{{stageIndex}}">
            <text class="stage-name">{{stage.label}}</text>
          </view>
        </view>
      </view>

      <!-- å·¥å•çŠ¶æ€ -->
      <view class="order-footer">
        <view class="status-badge status-{{item.status}}">{{item.statusText}}</view>
        <view class="order-actions" bindtap="viewOrderDetail" data-order="{{item}}">
          <text class="action-text">æŸ¥çœ‹è¯¦æƒ…</text>
          <text class="action-arrow">â†’</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†é¡µæ§ä»¶ -->
  <view class="pagination" wx:if="{{!loading && filteredOrders.length > 0 && totalPages > 1}}">
    <button class="pagination-btn {{!hasPrevPage ? 'disabled' : ''}}" bindtap="goToPrevPage" disabled="{{!hasPrevPage}}">
      <text class="pagination-icon">â€¹</text>
      <text class="pagination-text">ä¸Šä¸€é¡µ</text>
    </button>
    
    <view class="pagination-info">
      <text class="page-current">{{currentPage}}</text>
      <text class="page-separator">/</text>
      <text class="page-total">{{totalPages}}</text>
    </view>
    
    <button class="pagination-btn {{!hasNextPage ? 'disabled' : ''}}" bindtap="goToNextPage" disabled="{{!hasNextPage}}">
      <text class="pagination-text">ä¸‹ä¸€é¡µ</text>
      <text class="pagination-icon">â€º</text>
    </button>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && filteredOrders.length === 0}}">
    <view class="empty-icon">ğŸ“‹</view>
    <view class="empty-title">æš‚æ— å·¥å•æ•°æ®</view>
    <view class="empty-desc">è¿˜æ²¡æœ‰æäº¤ä»»ä½•å·¥å•ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹åˆ›å»º</view>
    <button class="empty-btn" bindtap="goToReport">ç«‹å³åˆ›å»ºå·¥å•</button>
  </view>

  <!-- åŠ è½½æ›´å¤šæç¤º -->
  <view class="load-more-tip" wx:if="{{!loading && filteredOrders.length > 0 && !hasNextPage}}">
    <text class="tip-text">å·²åŠ è½½å…¨éƒ¨æ•°æ®</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{filteredOrders.length > 0 ? 'åŠ è½½æ›´å¤šä¸­...' : 'åŠ è½½ä¸­...'}}</text>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab" bindtap="goToReport">
    <text class="fab-icon">+</text>
  </view>

  <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
  <view class="image-modal" wx:if="{{showImageModal}}" bindtap="closeImageModal">
    <view class="image-modal-content" catchtap="stopPropagation">
      <view class="image-modal-header">
        <text class="image-modal-title">å›¾ç‰‡é¢„è§ˆ ({{currentImageIndex + 1}}/{{modalImages.length}})</text>
        <text class="image-modal-close" bindtap="closeImageModal">Ã—</text>
      </view>
      <view class="image-modal-body">
        <swiper class="image-swiper" current="{{currentImageIndex}}" bindchange="onImageSwiperChange">
          <swiper-item wx:for="{{modalImages}}" wx:key="index">
            <image class="modal-image" src="{{item}}" mode="aspectFit" />
          </swiper-item>
        </swiper>
      </view>
      <!-- å›¾ç‰‡è·¯å¾„æ˜¾ç¤ºåŒºåŸŸ -->
      <view class="image-path-section">
        <view class="image-path-label">å›¾ç‰‡è·¯å¾„:</view>
        <view class="image-path-content">
          <text class="image-path-text" selectable="true">{{modalImages[currentImageIndex]}}</text>
          <text class="copy-path-btn" bindtap="copyImagePath" data-path="{{modalImages[currentImageIndex]}}">å¤åˆ¶</text>
        </view>
      </view>
      <view class="image-modal-footer" wx:if="{{modalImages.length > 1}}">
        <view class="image-dots">
          <view class="dot {{index === currentImageIndex ? 'active' : ''}}" 
                wx:for="{{modalImages}}" wx:key="index" 
                bindtap="switchToImage" data-index="{{index}}"></view>
        </view>
      </view>
    </view>
  </view>
</view>